 clc;close all
 
x0 = [-1 -1 -1];
xT = [1 1 1];
Delta = 0.1;
bd = [-1 -1 -1; 1 1 1];
C0 = [
    [0.2      0.2        0.2];
    [-0.3953   -0.7065   -0.8153];
    [-0.6275   -0.3089   -0.2065];
    [0.0776   -0.1616    0.3704];
    [-0.5911    0.7562   -0.9452];
    [0.3409   -0.1654    0.1174];
];
V0 = [
    [0.3      0.3        0.3];
    [0.8372   -0.0232    0.2235];
    [0.5318    0.0368   -0.4064];
    [-0.6246   -0.8385    0.4769];
    [-0.1174   -0.6834    0.7599];
    [-0.4518   -0.1715   -0.4078];
];
num_obs = size(C0,1);
t = msspoly( 't', 1 );
G = {
    @(x1,x2,x3) (27*t^2)/100 - (3*t*x1)/5 - (3*t*x2)/5 - (3*t*x3)/5 + (9*t)/25 + x1^2 - (2*x1)/5 + x2^2 - (2*x2)/5 + x3^2 - (2*x3)/5 + 29/300,...
    @(x1,x2,x3) ((27*t^2)/100 - (3*t*x1)/5 - (3*t*x2)/5 - (3*t*x3)/5 + (9*t)/25 + x1^2 - (2*x1)/5 + x2^2 - (2*x2)/5 + x3^2 - (2*x3)/5 + 299/3000)^2 - (1-Delta)*((729*t^4)/10000 - (81*t^3*x1)/250 - (81*t^3*x2)/250 - (81*t^3*x3)/250 + (243*t^3)/1250 + (9*t^2*x1^2)/10 + (18*t^2*x1*x2)/25 + (18*t^2*x1*x3)/25 - (81*t^2*x1)/125 + (9*t^2*x2^2)/10 + (18*t^2*x2*x3)/25 - (81*t^2*x2)/125 + (9*t^2*x3^2)/10 - (81*t^2*x3)/125 + (369*t^2)/2000 - (6*t*x1^3)/5 - (6*t*x1^2*x2)/5 - (6*t*x1^2*x3)/5 + (6*t*x1^2)/5 - (6*t*x1*x2^2)/5 + (24*t*x1*x2)/25 - (6*t*x1*x3^2)/5 + (24*t*x1*x3)/25 - (41*t*x1)/100 - (6*t*x2^3)/5 - (6*t*x2^2*x3)/5 + (6*t*x2^2)/5 - (6*t*x2*x3^2)/5 + (24*t*x2*x3)/25 - (41*t*x2)/100 - (6*t*x3^3)/5 + (6*t*x3^2)/5 - (41*t*x3)/100 + (183*t)/2500 + x1^4 - (4*x1^3)/5 + 2*x1^2*x2^2 - (4*x1^2*x2)/5 + 2*x1^2*x3^2 - (4*x1^2*x3)/5 + (109*x1^2)/300 - (4*x1*x2^2)/5 + (8*x1*x2)/25 - (4*x1*x3^2)/5 + (8*x1*x3)/25 - (61*x1)/750 + x2^4 - (4*x2^3)/5 + 2*x2^2*x3^2 - (4*x2^2*x3)/5 + (109*x2^2)/300 - (4*x2*x3^2)/5 + (8*x2*x3)/25 - (61*x2)/750 + x3^4 - (4*x3^3)/5 + (109*x3^2)/300 - (61*x3)/750 + 387197158107163488475127/36893488147419103232000000),...
    @(x1,x2,x3) (75139433*t^2)/100000000 - (2093*t*x1)/1250 + (29*t*x2)/625 - (447*t*x3)/1000 - (49677391*t)/50000000 + x1^2 + (3953*x1)/5000 + x2^2 + (1413*x2)/1000 + x3^2 + (8153*x3)/5000 + 389035529/300000000,...
    @(x1,x2,x3) ((75139433*t^2)/100000000 - (2093*t*x1)/1250 + (29*t*x2)/625 - (447*t*x3)/1000 - (49677391*t)/50000000 + x1^2 + (3953*x1)/5000 + x2^2 + (1413*x2)/1000 + x3^2 + (8153*x3)/5000 + 389935529/300000000)^2 - (1-Delta)*((5645934391561489*t^4)/10000000000000000 - (157266833269*t^3*x1)/62500000000 + (2179043557*t^3*x2)/31250000000 - (33587326551*t^3*x3)/50000000000 - (3732730992659303*t^3)/2500000000000000 + (215320201*t^2*x1^2)/50000000 - (60697*t^2*x1*x2)/390625 + (935571*t^2*x1*x3)/625000 + (1128824413553*t^2*x1)/250000000000 + (75247081*t^2*x2^2)/50000000 - (12963*t^2*x2*x3)/312500 + (507809784721*t^2*x2)/250000000000 + (85129883*t^2*x3^2)/50000000 + (834669735019*t^2*x3)/250000000000 + (44151677274816343*t^2)/15000000000000000 - (2093*t*x1^3)/625 + (58*t*x1^2*x2)/625 - (447*t*x1^2*x3)/500 - (115866423*t*x1^2)/25000000 - (2093*t*x1*x2^2)/625 - (14557771*t*x1*x2)/3125000 - (2093*t*x1*x3^2)/625 - (77091871*t*x1*x3)/12500000 - (2223905904263*t*x1)/375000000000 + (58*t*x2^3)/625 - (447*t*x2^2*x3)/500 - (46399231*t*x2^2)/25000000 + (58*t*x2*x3^2)/625 - (13898779*t*x2*x3)/12500000 - (1007610180881*t*x2)/375000000000 - (447*t*x3^3)/500 - (86121301*t*x3^2)/25000000 - (1100988506751*t*x3)/250000000000 - (19400786173524839*t)/7500000000000000 + x1^4 + (3953*x1^3)/2500 + 2*x1^2*x2^2 + (1413*x1^2*x2)/500 + 2*x1^2*x3^2 + (8153*x1^2*x3)/2500 + (484292783*x1^2)/150000000 + (3953*x1*x2^2)/2500 + (5585589*x1*x2)/2500000 + (3953*x1*x3^2)/2500 + (32228809*x1*x3)/12500000 + (1543786946137*x1)/750000000000 + x2^4 + (1413*x2^3)/500 + 2*x2^2*x3^2 + (8153*x2^2*x3)/2500 + (690020879*x2^2)/150000000 + (1413*x2*x3^2)/500 + (11520189*x2*x3)/2500000 + (183942234159*x2)/50000000000 + x3^4 + (8153*x3^3)/2500 + (789363983*x3^2)/150000000 + (3184036167937*x3)/750000000000 + 1831851751441973136832878290597821/1080863910568919040000000000000000),...
    @(x1,x2,x3) (11233161*t^2)/25000000 - (2659*t*x1)/2500 - (46*t*x2)/625 + (508*t*x3)/625 - (13057521*t)/25000000 + x1^2 + (251*x1)/200 + x2^2 + (3089*x2)/5000 + x3^2 + (413*x3)/1000 + 152545313/300000000,...
    @(x1,x2,x3) ((11233161*t^2)/25000000 - (2659*t*x1)/2500 - (46*t*x2)/625 + (508*t*x3)/625 - (13057521*t)/25000000 + x1^2 + (251*x1)/200 + x2^2 + (3089*x2)/5000 + x3^2 + (413*x3)/1000 + 153445313/300000000)^2 - (1-Delta)*((126183906051921*t^4)/625000000000000 - (29868975099*t^3*x1)/31250000000 - (258362703*t^3*x2)/3906250000 + (1426611447*t^3*x3)/1953125000 - (146677235653881*t^3)/312500000000000 + (25373723*t^2*x1^2)/12500000 + (61157*t^2*x1*x2)/390625 - (675386*t^2*x1*x3)/390625 + (139927981953*t^2*x1)/62500000000 + (11300873*t^2*x2^2)/12500000 - (46736*t^2*x2*x3)/390625 + (39504402057*t^2*x2)/62500000000 + (19491209*t^2*x3^2)/12500000 - (29869287879*t^2*x3)/62500000000 + (917802976739013*t^2)/1250000000000000 - (2659*t*x1^3)/1250 - (92*t*x1^2*x2)/625 + (1016*t*x1^2*x3)/625 - (46427971*t*x1^2)/12500000 - (2659*t*x1*x2^2)/1250 - (9368251*t*x1*x2)/6250000 - (2659*t*x1*x3^2)/1250 + (1451993*t*x1*x3)/1250000 - (901222152917*t*x1)/375000000000 - (92*t*x2^3)/625 + (1016*t*x2^2*x3)/625 - (14194273*t*x2^2)/12500000 - (92*t*x2*x3^2)/625 + (737111*t*x2*x3)/781250 - (135176215903*t*x2)/187500000000 + (1016*t*x3^3)/625 - (4665361*t*x3^2)/12500000 + (75618695413*t*x3)/187500000000 - (670483303149691*t)/1250000000000000 + x1^4 + (251*x1^3)/100 + 2*x1^2*x2^2 + (3089*x1^2*x2)/2500 + 2*x1^2*x3^2 + (413*x1^2*x3)/500 + (390299063*x1^2)/150000000 + (251*x1*x2^2)/100 + (775339*x1*x2)/500000 + (251*x1*x3^2)/100 + (103663*x1*x3)/100000 + (38665373563*x1)/30000000000 + x2^4 + (3089*x2^3)/2500 + 2*x2^2*x3^2 + (413*x2^2*x3)/500 + (211296839*x2^2)/150000000 + (3089*x2*x3^2)/2500 + (1275757*x2*x3)/2500000 + (475845971857*x2)/750000000000 + x3^4 + (413*x3^3)/500 + (179630663*x3^2)/150000000 + (63620714269*x3)/150000000000 + 95053007591414020808390148947263/360287970189639680000000000000000),...
    @(x1,x2,x3) (66032051*t^2)/50000000 + (3123*t*x1)/2500 + (1677*t*x2)/1000 - (4769*t*x3)/5000 + (659191*t)/1250000 + x1^2 - (97*x1)/625 + x2^2 + (202*x2)/625 + x3^2 - (463*x3)/625 + 684371/4687500,...
    @(x1,x2,x3) ((66032051*t^2)/50000000 + (3123*t*x1)/2500 + (1677*t*x2)/1000 - (4769*t*x3)/5000 + (659191*t)/1250000 + x1^2 - (97*x1)/625 + x2^2 + (202*x2)/625 + x3^2 - (463*x3)/625 + 1396867/9375000)^2 - (1-Delta)*((4360231759266601*t^4)/2500000000000000 + (206218095273*t^3*x1)/62500000000 + (110735749527*t^3*x2)/25000000000 - (314906851219*t^3*x3)/125000000000 + (43527733730741*t^3)/31250000000000 + (105044567*t^2*x1^2)/25000000 + (5237271*t^2*x1*x2)/1250000 - (14893587*t^2*x1*x3)/6250000 + (14181425983*t^2*x1)/15625000000 + (34085069*t^2*x2^2)/6250000 - (7997613*t^2*x2*x3)/2500000 + (40975056977*t^2*x2)/15625000000 + (22193853*t^2*x3^2)/6250000 - (2893203063*t^2*x3)/976562500 + (158656010112617*t^2)/234375000000000 + (3123*t*x1^3)/1250 + (1677*t*x1^2*x2)/500 - (4769*t*x1^2*x3)/2500 + (2084231*t*x1^2)/3125000 + (3123*t*x1*x2^2)/1250 + (448347*t*x1*x2)/1562500 + (3123*t*x1*x3^2)/1250 - (485861*t*x1*x3)/312500 + (834242027*t*x1)/3906250000 + (1677*t*x2^3)/500 - (4769*t*x2^2*x3)/2500 + (1336699*t*x2^2)/625000 + (1677*t*x2*x3^2)/500 - (4845593*t*x2*x3)/1562500 + (1323956231*t*x2)/1562500000 - (4769*t*x3^3)/2500 + (7712049*t*x3^2)/3125000 - (25063403453*t*x3)/23437500000 + (933161985847*t)/5859375000000 + x1^4 - (194*x1^3)/625 + 2*x1^2*x2^2 + (404*x1^2*x2)/625 + 2*x1^2*x3^2 - (926*x1^2*x3)/625 + (61141*x1^2)/187500 - (194*x1*x2^2)/625 - (39188*x1*x2)/390625 - (194*x1*x3^2)/625 + (89822*x1*x3)/390625 - (137314849*x1)/2929687500 + x2^4 + (404*x2^3)/625 + 2*x2^2*x3^2 - (926*x2^2*x3)/625 + (381053*x2^2)/937500 + (404*x2*x3^2)/625 - (187052*x2*x3)/390625 + (142977317*x2)/1464843750 + x3^4 - (926*x3^3)/625 + (797609*x3^2)/937500 - (655430671*x3)/2929687500 + 8272078915207955337680647421247/360287970189639680000000000000000),...
    @(x1,x2,x3) (105826633*t^2)/100000000 + (587*t*x1)/2500 + (3417*t*x2)/2500 - (7599*t*x3)/5000 - (58282471*t)/25000000 + x1^2 + (5911*x1)/5000 + x2^2 - (3781*x2)/2500 + x3^2 + (2363*x3)/1250 + 537392207/300000000,...
    @(x1,x2,x3) ((105826633*t^2)/100000000 + (587*t*x1)/2500 + (3417*t*x2)/2500 - (7599*t*x3)/5000 - (58282471*t)/25000000 + x1^2 + (5911*x1)/5000 + x2^2 - (3781*x2)/2500 + x3^2 + (2363*x3)/1250 + 538292207/300000000)^2 - (1-Delta)*((11199276252116689*t^4)/10000000000000000 + (62120233571*t^3*x1)/125000000000 + (361609604961*t^3*x2)/125000000000 - (804176584167*t^3*x3)/250000000000 - (6167837668850143*t^3)/1250000000000000 + (21716637*t^2*x1^2)/10000000 + (2005779*t^2*x1*x2)/3125000 - (4460613*t^2*x1*x3)/6250000 + (351846743847*t^2*x1)/250000000000 + (39846749*t^2*x2^2)/10000000 - (25965783*t^2*x2*x3)/6250000 - (1196735313001*t^2*x2)/125000000000 + (44263247*t^2*x3^2)/10000000 + (173239207727*t^2*x3)/15625000000 + (27710692407505843*t^2)/3000000000000000 + (587*t*x1^3)/1250 + (3417*t*x1^2*x2)/1250 - (7599*t*x1^2*x3)/2500 - (51342957*t*x1^2)/12500000 + (587*t*x1*x2^2)/1250 + (15758993*t*x1*x2)/6250000 + (587*t*x1*x3^2)/1250 - (33821041*t*x1*x3)/12500000 - (1750716390977*t*x1)/375000000000 + (3417*t*x2^3)/1250 - (7599*t*x2^2*x3)/2500 - (109961179*t*x2^2)/12500000 + (3417*t*x2*x3^2)/1250 + (61029303*t*x2*x3)/6250000 + (1495262315177*t*x2)/125000000000 - (7599*t*x3^3)/2500 - (130108219*t*x3^2)/12500000 - (3568557623899*t*x3)/250000000000 - (31407969426603497*t)/3750000000000000 + x1^4 + (5911*x1^3)/2500 + 2*x1^2*x2^2 - (3781*x1^2*x2)/1250 + 2*x1^2*x3^2 + (2363*x1^2*x3)/625 + (748531733*x1^2)/150000000 + (5911*x1*x2^2)/2500 - (22349491*x1*x2)/6250000 + (5911*x1*x3^2)/2500 + (13967693*x1*x3)/3125000 + (3185391835577*x1)/750000000000 + x2^4 - (3781*x2^3)/1250 + 2*x2^2*x3^2 + (2363*x2^2*x3)/625 + (881995271*x2^2)/150000000 - (3781*x2*x3^2)/1250 - (8934503*x2*x3)/1562500 - (2037551434667*x2)/375000000000 + x3^4 + (2363*x3^3)/625 + (1074934031*x3^2)/150000000 + (1273402285141*x3)/187500000000 + 1162605688021346502178411326537023/360287970189639680000000000000000),...
    @(x1,x2,x3) (39983633*t^2)/100000000 + (2259*t*x1)/2500 + (343*t*x2)/1000 + (2039*t*x3)/2500 - (2169103*t)/6250000 + x1^2 - (3409*x1)/5000 + x2^2 + (827*x2)/2500 + x3^2 - (587*x3)/2500 + 40205819/300000000,...
    @(x1,x2,x3) ((39983633*t^2)/100000000 + (2259*t*x1)/2500 + (343*t*x2)/1000 + (2039*t*x3)/2500 - (2169103*t)/6250000 + x1^2 - (3409*x1)/5000 + x2^2 + (827*x2)/2500 + x3^2 - (587*x3)/2500 + 41105819/300000000)^2 - (1-Delta)*((1598690907878689*t^4)/10000000000000000 + (90323026947*t^3*x1)/125000000000 + (13714386119*t^3*x2)/50000000000 + (81526627687*t^3*x3)/125000000000 - (86728618291199*t^3)/312500000000000 + (80808281*t^2*x1^2)/50000000 + (774837*t^2*x1*x2)/1250000 + (4606101*t^2*x1*x3)/3125000 - (293104322561*t^2*x1)/250000000000 + (45866083*t^2*x2^2)/50000000 + (699377*t^2*x2*x3)/1250000 + (3306371331*t^2*x2)/125000000000 + (73243801*t^2*x3^2)/50000000 - (94235208843*t^2*x3)/125000000000 + (3474273165510283*t^2)/15000000000000000 + (2259*t*x1^3)/1250 + (343*t*x1^2*x2)/500 + (2039*t*x1^2*x3)/1250 - (12039137*t*x1^2)/6250000 + (2259*t*x1*x2^2)/1250 + (1626337*t*x1*x2)/12500000 + (2259*t*x1*x3^2)/1250 - (9603017*t*x1*x3)/6250000 + (90560258723*t*x1)/125000000000 + (343*t*x2^3)/500 + (2039*t*x2^2*x3)/1250 - (2919901*t*x2^2)/6250000 + (343*t*x2*x3^2)/500 + (2365801*t*x2*x3)/6250000 - (100683945791*t*x2)/750000000000 + (2039*t*x3^3)/1250 - (841499*t*x3^2)/781250 + (146154811069*t*x3)/375000000000 - (90464217110357*t)/937500000000000 + x1^4 - (3409*x1^3)/2500 + 2*x1^2*x2^2 + (827*x1^2*x2)/1250 + 2*x1^2*x3^2 - (587*x1^2*x3)/1250 + (22286701*x1^2)/30000000 - (3409*x1*x2^2)/2500 - (2819243*x1*x2)/6250000 - (3409*x1*x3^2)/2500 + (2001083*x1*x3)/6250000 - (142175136971*x1)/750000000000 + x2^4 + (827*x2^3)/1250 + 2*x2^2*x3^2 - (587*x2^2*x3)/1250 + (11624023*x2^2)/30000000 + (827*x2*x3^2)/1250 - (485449*x2*x3)/3125000 + (34490712313*x2)/375000000000 + x3^4 - (587*x3^3)/1250 + (1999019*x3^2)/6000000 - (24481315753*x3)/375000000000 + 7020312534062854837815027760447/360287970189639680000000000000000),...
};% constraints >=0
dm = 3;
num_pieces = 3;
[V, E, path, path_points] = RRT_SOS_Dynamic(dm, G, x0, xT, bd, t, num_pieces);


%% Trajectory Plots
num_pieces = size(path_points, 1);
x0 = path_points(1,1:3); xT = path_points(end,4:6);
fig_num = 1;
for t=[0:0.1:0.7 0.8 0.85 0.9 1]
subplot(3,4,fig_num);fig_num=fig_num+1;hold on;view(-70,45)
    for i=1:num_pieces % full path
        plot3([path_points(i,1), path_points(i,4)], [path_points(i,2), path_points(i,5)], [path_points(i,3), path_points(i,6)], 'LineWidth',2,'Color','g');
    end

    for i=1:num_pieces % path at time t
        if t >= (i-1)/num_pieces && t <= i/num_pieces
            cur_x = path_points(i,1:3) + (t-(i-1)/num_pieces)*num_pieces*(path_points(i,4:6) -path_points(i,1:3));
            plot3(cur_x(1),cur_x(2),cur_x(3),'o','LineWidth',2,'MarkerSize',5,'MarkerEdgeColor','k','MarkerFaceColor','k'); 
        end
    end
end